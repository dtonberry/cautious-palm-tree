!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).rexshatterimageplugin=e()}(this,function(){"use strict";function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function t(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function f(n){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=s(n);if(i){var r=s(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return a(this,t)}}function i(t,e,r){return(i="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=s(t)););return t}(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(r):i.value}})(t,e,r||t)}function C(t){var e,r,n,i,s,a,o=t.rectangle;a=o?(e=o.x,n=o.y,s=o.width,o.height):(n=e=0,s=t.width,t.height),r=e+s,i=n+a;var u,h,c=t.center;h=void 0===c?(u=(e+r)/2,(n+i)/2):(u=P(c.x,e,r),P(c.y,n,i));var f=[];f.push([u,h]);for(var l=x(t,"samplesPerRing",12),v=x(t,"variation",.25),p=Math.min(s,a),y=1-v,g=1+v,d=0;d<3;d++)w(f,u,h,p*Math.pow(3,d)/27,l,y,g,e,r,n,i);return p=2*Math.min(s,a),w(f,u,h,p,l,y,g,e,r,n,i),function(t,e){void 0===e&&(e=!0);var r=m.triangulate(t);if(e){for(var n=[],i=0,s=r.length;i<s;i+=3){var a=t[r[i+0]],o=t[r[i+1]],u=t[r[i+2]],h=new b(a[0],a[1],o[0],o[1],u[0],u[1]);n.push(h)}return n}return{vertices:t,indices:r}}(f,x(t,"triangleOutput",!0))}var o,m=(function(t){var e,w;function y(t,e,r,n){var i,s,a,o,u,h,c,f,l,v,p=t[e][0],y=t[e][1],g=t[r][0],d=t[r][1],m=t[n][0],b=t[n][1],x=Math.abs(y-d),P=Math.abs(d-b);if(x<w&&P<w)throw new Error("Eek! Coincident points!");return s=x<w?(o=-(m-g)/(b-d))*((i=(g+p)/2)-(h=(g+m)/2))+(f=(d+b)/2):P<w?(a=-(g-p)/(d-y))*((i=(m+g)/2)-(u=(p+g)/2))+(c=(y+d)/2):(i=((a=-(g-p)/(d-y))*(u=(p+g)/2)-(o=-(m-g)/(b-d))*(h=(g+m)/2)+(f=(d+b)/2)-(c=(y+d)/2))/(a-o),P<x?a*(i-u)+c:o*(i-h)+f),{i:e,j:r,k:n,x:i,y:s,r:(l=g-i)*l+(v=d-s)*v}}function g(t){var e,r,n,i,s,a;for(r=t.length;r;)for(i=t[--r],n=t[--r],e=r;e;)if(a=t[--e],n===(s=t[--e])&&i===a||n===a&&i===s){t.splice(r,2),t.splice(e,2);break}}w=1/1048576,e={triangulate:function(r,t){var e,n,i,s,a,o,u,h,c,f,l,v,p=r.length;if(p<3)return[];if(r=r.slice(0),t)for(e=p;e--;)r[e]=r[e][t];for(i=new Array(p),e=p;e--;)i[e]=e;for(i.sort(function(t,e){return r[e][0]-r[t][0]}),s=function(t){var e,r,n,i,s,a,o=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(e=t.length;e--;)t[e][0]<o&&(o=t[e][0]),t[e][0]>h&&(h=t[e][0]),t[e][1]<u&&(u=t[e][1]),t[e][1]>c&&(c=t[e][1]);return n=c-u,[[(s=o+.5*(r=h-o))-20*(i=Math.max(r,n)),(a=u+.5*n)-i],[s,a+20*i],[s+20*i,a-i]]}(r),r.push(s[0],s[1],s[2]),a=[y(r,p+0,p+1,p+2)],o=[],u=[],e=i.length;e--;u.length=0){for(v=i[e],n=a.length;n--;)0<(h=r[v][0]-a[n].x)&&h*h>a[n].r?(o.push(a[n]),a.splice(n,1)):h*h+(c=r[v][1]-a[n].y)*c-a[n].r>w||(u.push(a[n].i,a[n].j,a[n].j,a[n].k,a[n].k,a[n].i),a.splice(n,1));for(g(u),n=u.length;n;)l=u[--n],f=u[--n],a.push(y(r,f,l,v))}for(e=a.length;e--;)o.push(a[e]);for(a.length=0,e=o.length;e--;)o[e].i<p&&o[e].j<p&&o[e].k<p&&a.push(o[e].i,o[e].j,o[e].k);return a},contains:function(t,e){if(e[0]<t[0][0]&&e[0]<t[1][0]&&e[0]<t[2][0]||e[0]>t[0][0]&&e[0]>t[1][0]&&e[0]>t[2][0]||e[1]<t[0][1]&&e[1]<t[1][1]&&e[1]<t[2][1]||e[1]>t[0][1]&&e[1]>t[1][1]&&e[1]>t[2][1])return null;var r=t[1][0]-t[0][0],n=t[2][0]-t[0][0],i=t[1][1]-t[0][1],s=t[2][1]-t[0][1],a=r*s-n*i;if(0==a)return null;var o=(s*(e[0]-t[0][0])-n*(e[1]-t[0][1]))/a,u=(r*(e[1]-t[0][1])-i*(e[0]-t[0][0]))/a;return o<0||u<0||1<o+u?null:[o,u]}},t.exports=e}(o={exports:{}}),o.exports),b=Phaser.Geom.Triangle,x=Phaser.Utils.Objects.GetValue,P=Phaser.Math.Clamp,y=2*Math.PI,w=function(t,e,r,n,i,s,a,o,u,h,c){for(var f=0;f<i;f++){var l=f/i*y,v=e+Math.cos(l)*n*g(s,a),p=r+Math.sin(l)*n*g(s,a);v=P(v,o,u),p=P(p,h,c),t.push([v,p])}return t},g=function(t,e){return t===e?t:t+(e-t)*Math.random()},h=Phaser.Geom.Mesh.Face,l=Phaser.Math.DegToRad,v=Phaser.Math.RadToDeg,p=Phaser.Geom.Mesh.RotateFace,V=function(){e(s,h);var i=f(s);function s(t,e,r){var n;return c(this,s),(n=i.call(this,t,e,r))._rotation=0,n}return t(s,[{key:"rotation",get:function(){return this._rotation},set:function(t){p(this,t-this._rotation),this._rotation=t}},{key:"setRotation",value:function(t){return this.rotation=t,this}},{key:"angle",get:function(){return v(this.rotation)},set:function(t){this.rotation=l(t)}},{key:"setAngle",value:function(t){return this.angle=t,this}},{key:"setAlpha",value:function(t){return this.alpha=t,this}}]),s}(),E=Phaser.Math.RotateAround,U={x:0,y:0},d=Phaser.GameObjects.Mesh,O=Phaser.Utils.Objects.IsPlainObject,j=Phaser.Utils.Objects.GetValue,R=Phaser.Geom.Mesh.GenerateGridVerts,A=Phaser.Geom.Mesh.Vertex,D=Phaser.Math.Distance.Squared,I=function(){e(u,d);var o=f(u);function u(t,e,r,n,i,s){var a;return c(this,u),O(e)&&(e=j(s=e,"x",0),r=j(s,"y",0),n=j(s,"key",null),i=j(s,"frame",null)),(a=o.call(this,t,e,r,n,i)).type="rexShatterImage",a.hideCCW=!1,a.resetImage(),a.shatterCenter={x:null,y:null},a.setVariation(j(s,"variation",.25)),a.setSamplesPerRing(j(s,"samplesPerRing",12)),a}return t(u,[{key:"setVariation",value:function(t){return this.variation=t,this}},{key:"setSamplesPerRing",value:function(t){return this.samplesPerRing=t,this}},{key:"resetImage",value:function(){return this.setSizeToFrame(),this.clear(),this.dirtyCache[9]=-1,R({mesh:this,texture:this.texture.key,frame:this.frame.name,width:this.frame.cutWidth/this.height,height:this.frame.cutHeight/this.height,flipY:this.frame.source.isRenderTexture}),this.setOrtho(this.width/this.height,1),this}},{key:"shatter",value:function(t,e){if(void 0===t)t=this.width/2,e=this.height/2;else{var r=(i=t,s=e,a=(n=this).width/2,o=n.height/2,U.x=i-n.x,U.y=s-n.y,U.x/=n.scaleX,U.y/=n.scaleY,E(U,a,o,-n.rotation),U.x+=a,U.y+=o,U);t=r.x,e=r.y}var n,i,s,a,o;if(this.shatterCenter.x=t,this.shatterCenter.y=e,this.clear(),this.dirtyCache[9]=-1,0===this.width||0===this.height)return this;for(var u=C({width:this.width,height:this.height,center:this.shatterCenter,triangleOutput:!1,variation:this.variation,samplesPerRing:this.samplesPerRing}),h=u.vertices,c=u.indices,f=[],l=this.width,v=this.height,p=this.frame.cutWidth/v/2,y=this.frame.cutHeight/v/2,g=this.frame.source.isRenderTexture,d=this.frame.u0,m=this.frame.u1,b=g?this.frame.v1:this.frame.v0,x=m-d,P=(g?this.frame.v0:this.frame.v1)-b,w=0,O=h.length;w<O;w++){var j=h[w],R=j[0],I=j[1];f.push({g:D(t,e,R,I),x:R/v-p,y:I/v-y,u:d+R/l*x,v:b+I/v*P})}for(w=0,O=c.length;w<O;w+=3){var k=f[c[w+0]],G=f[c[w+1]],T=f[c[w+2]],M=new A(k.x,-k.y,0,k.u,k.v),S=new A(G.x,-G.y,0,G.u,G.v),_=new A(T.x,-T.y,0,T.u,T.v),N=new V(M,S,_);this.vertices.push(M,S,_),this.faces.push(N),N.g=Math.min(k.g,G.g,T.g)}return this.faces.sort(function(t,e){return t.g-e.g}),this}},{key:"startUpdate",value:function(){return this.ignoreDirtyCache=!0,this}},{key:"stopUpdate",value:function(){return this.ignoreDirtyCache=!1,this}}]),u}();function k(t,e,r,n,i){var s=new I(this.scene,t,e,r,n,i);return this.scene.add.existing(s),s}var G=Phaser.Utils.Objects.GetAdvancedValue,T=Phaser.GameObjects.BuildGameObject;function M(t,e){void 0===t&&(t={}),void 0!==e&&(t.add=e);var r=G(t,"key",null),n=G(t,"frame",null),i=new I(this.scene,0,0,r,n,t);return T(this.scene,i,t),i}var S=Phaser.GameObjects.RenderTexture,_=Phaser.Utils.Objects.IsPlainObject,N=Phaser.Utils.Objects.GetValue,F=function(){e(h,I);var u=f(h);function h(t,e,r,n,i,s){var a;c(this,h),_(e)&&(e=N(s=e,"x",0),r=N(s,"y",0),n=N(s,"width",32),i=N(s,"height",32));var o=new S(t,e,r,n,i).setOrigin(.5);return(a=u.call(this,t,e,r,o.texture.key,null,s)).type="rexShatterRenderTexture",a.rt=o,a}return t(h,[{key:"destroy",value:function(t){i(s(h.prototype),"destroy",this).call(this,t),this.rt.destroy(),this.rt=null}}]),h}();function Y(t,e,r,n,i){var s=new F(this.scene,t,e,r,n,i);return this.scene.add.existing(s),s}var B=Phaser.Utils.Objects.GetAdvancedValue,W=Phaser.GameObjects.BuildGameObject;function H(t,e){void 0===t&&(t={}),void 0!==e&&(t.add=e);var r=B(t,"x",0),n=B(t,"y",0),i=B(t,"width",32),s=B(t,"height",32),a=new F(this.scene,r,n,i,s,t);return W(this.scene,a,t),a}function q(t){return null==t||""===t||0===t.length}function z(t,e,r){if("object"===u(t)){if(q(e)){if(null==r)return;"object"===u(r)&&(t=r)}else{"string"==typeof e&&(e=e.split("."));var n=e.pop();(function(t,e,r){var n=t;if(!q(e)){var i;"string"==typeof e&&(e=e.split("."));for(var s=0,a=e.length;s<a;s++){var o;if(null==n[i=e[s]]||"object"!==u(n[i]))o=s!==a-1||void 0===r?{}:r,n[i]=o;n=n[i]}}return n})(t,e)[n]=r}return t}}var X=function(){e(n,Phaser.Plugins.BasePlugin);var r=f(n);function n(t){var e;return c(this,n),e=r.call(this,t),t.registerGameObject("rexShatterImage",k,M),t.registerGameObject("rexShatterRenderTexture",Y,H),e}return t(n,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}}]),n}();return z(window,"RexPlugins.GameObjects.ShatterImage",I),z(window,"RexPlugins.GameObjects.ShatterRenderTexture",F),X});
